import React, { useState, useMemo } from 'react';
import { 
  BarChart, 
  Bar, 
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip, 
  Legend, 
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell
} from 'recharts';
import { 
  Sun, 
  Moon, 
  Zap, 
  Droplets, 
  TrendingUp, 
  Users, 
  DollarSign, 
  Activity,
  Check
} from 'lucide-react';

// --- Mock Data Generator ---
// Helper to generate realistic-looking data from 2013 to 2025
const generateData = () => {
  const years = Array.from({ length: 13 }, (_, i) => 2013 + i);
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  
  const data = {};

  years.forEach(year => {
    // Random learner count between 800 and 1200, growing slightly each year
    const learnerCount = Math.floor(800 + (year - 2013) * 30 + Math.random() * 50);

    const yearlyData = months.map(month => {
      // Seasonal factors (Winter peak for electricity, Summer peak for water)
      const isWinter = ['Jun', 'Jul', 'Aug'].includes(month);
      const isSummer = ['Dec', 'Jan', 'Feb'].includes(month);
      
      // Electricity Data (Rand & kWh)
      const kwhBase = 15000 + (year - 2013) * 500; // Consumption grows over years
      const kwh = Math.floor(kwhBase * (isWinter ? 1.4 : 1.0) + Math.random() * 2000);
      
      const energyCharge = kwh * (1.5 + (year - 2013) * 0.15); // Rate increases yearly
      const serviceCharge = 2000 + (year - 2013) * 100;
      const networkCharge = 1500 + (year - 2013) * 80;
      const networkSurcharge = networkCharge * 0.1;
      const sundryCharges = Math.random() > 0.8 ? 500 : 0; // Occasional
      const miscCharges = Math.random() > 0.9 ? 200 : 0;
      const subTotalElec = energyCharge + serviceCharge + networkCharge + networkSurcharge + sundryCharges + miscCharges;
      const vatElec = subTotalElec * 0.15;

      // Water Data (Rand & KL)
      const klBase = 1200 + (year - 2013) * 50;
      const kl = Math.floor(klBase * (isSummer ? 1.3 : 1.0) + Math.random() * 200);

      const waterCharge = kl * (15 + (year - 2013) * 2); // Rate increases
      const sewageCharge = kl * 0.7 * (10 + (year - 2013) * 1.5);
      const dsml = 500 + (year - 2013) * 50; // Daily Service Charge?
      const sundryWater = Math.random() > 0.9 ? 300 : 0;
      const miscWater = Math.random() > 0.95 ? 150 : 0;
      const subTotalWater = waterCharge + sewageCharge + dsml + sundryWater + miscWater;
      const vatWater = subTotalWater * 0.15;

      return {
        month,
        learnerCount,
        electricity: {
          usage: kwh,
          breakdown: {
            'Energy Charge': energyCharge,
            'Service Charge': serviceCharge,
            'Network Charge': networkCharge,
            'Network Surcharge': networkSurcharge,
            'Sundry Charges': sundryCharges,
            'Miscellaneous Charges': miscCharges,
            'VAT': vatElec,
            'Total Cost': subTotalElec + vatElec
          }
        },
        water: {
          usage: kl,
          breakdown: {
            'Water Charge': waterCharge,
            'Sewage Charges': sewageCharge,
            'DSML': dsml,
            'Sundry Charges': sundryWater,
            'Miscellaneous Charges': miscWater,
            'VAT': vatWater,
            'Total Cost': subTotalWater + vatWater
          }
        }
      };
    });

    data[year] = yearlyData;
  });

  return { years, data };
};

const { years: YEARS, data: MOCK_DATA } = generateData();

// --- Components ---

const KPICard = ({ title, value, subtext, icon: Icon, colorClass, isDark }) => (
  <div className={`p-4 rounded-xl shadow-sm border transition-colors duration-300
    ${isDark ? 'bg-gray-800 border-gray-700 text-white' : 'bg-white border-gray-200 text-gray-800'}`}>
    <div className="flex justify-between items-start mb-2">
      <div className={`p-2 rounded-lg ${colorClass} bg-opacity-10`}>
        <Icon className={`w-5 h-5 ${colorClass.replace('bg-', 'text-')}`} />
      </div>
      <span className={`text-xs font-medium px-2 py-1 rounded-full 
        ${isDark ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-600'}`}>
        Annual
      </span>
    </div>
    <h3 className={`text-sm font-medium ${isDark ? 'text-gray-400' : 'text-gray-500'}`}>{title}</h3>
    <p className="text-2xl font-bold mt-1">{value}</p>
    <p className={`text-xs mt-1 ${isDark ? 'text-gray-500' : 'text-gray-400'}`}>{subtext}</p>
  </div>
);

const PIE_COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1', '#64748b'];

const CostBreakdownPie = ({ data, utilityType, isDark }) => {
  const breakdownData = useMemo(() => {
    // 1. Identify keys to exclude from the pie chart (Totals)
    const excludeKeys = ['Total Cost'];
    
    // 2. Aggregate totals for the year
    const totals = {};
    data.forEach(month => {
      const breakdown = month[utilityType].breakdown;
      Object.keys(breakdown).forEach(key => {
        if (!excludeKeys.includes(key)) {
          totals[key] = (totals[key] || 0) + breakdown[key];
        }
      });
    });

    // 3. Convert to array and sort by value
    return Object.entries(totals)
      .map(([name, value]) => ({ name, value }))
      .filter(item => item.value > 0)
      .sort((a, b) => b.value - a.value);
  }, [data, utilityType]);

  return (
    <div className="flex flex-col items-center justify-center h-full w-full">
      <div className="h-56 w-full"> {/* Slightly smaller height for the pie */}
        <ResponsiveContainer width="100%" height="100%">
          <PieChart>
            <Pie
              data={breakdownData}
              cx="50%"
              cy="50%"
              innerRadius={50}
              outerRadius={70}
              paddingAngle={5}
              dataKey="value"
            >
              {breakdownData.map((entry, index) => (
                <Cell key={`cell-${index}`} fill={PIE_COLORS[index % PIE_COLORS.length]} stroke={isDark ? '#1f2937' : '#fff'} />
              ))}
            </Pie>
            <Tooltip 
              formatter={(value) => `R ${value.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`}
              contentStyle={{ 
                backgroundColor: isDark ? '#1f2937' : '#fff', 
                borderColor: isDark ? '#374151' : '#e5e7eb',
                color: isDark ? '#fff' : '#000',
                borderRadius: '8px'
              }}
            />
          </PieChart>
        </ResponsiveContainer>
      </div>
      {/* Changed to a 2-column grid to compact the list */}
      <div className="w-full grid grid-cols-2 gap-x-2 gap-y-1 mt-2">
        {breakdownData.map((entry, index) => (
          <div key={index} className="flex items-center text-xs">
            <div 
              className="w-2.5 h-2.5 rounded-full mr-2 shrink-0" 
              style={{ backgroundColor: PIE_COLORS[index % PIE_COLORS.length] }}
            />
            <span className={`truncate ${isDark ? 'text-gray-300' : 'text-gray-600'}`}>{entry.name}</span>
          </div>
        ))}
      </div>
    </div>
  );
};

export default function MunicipalChargesApp() {
  const [activeTab, setActiveTab] = useState('electricity'); // 'electricity' | 'water'
  const [selectedYear, setSelectedYear] = useState(2025);
  // Replaced independent booleans with a single 'mode' state
  const [chartMetric, setChartMetric] = useState('usage'); // 'usage' | 'cost'
  const [isDarkMode, setIsDarkMode] = useState(false);

  const currentData = MOCK_DATA[selectedYear] || [];
  
  // Calculations for KPIs
  const stats = useMemo(() => {
    let totalCost = 0;
    let totalUsage = 0;
    let learnerCountAvg = 0;

    currentData.forEach(m => {
      totalCost += m[activeTab].breakdown['Total Cost'];
      totalUsage += m[activeTab].usage;
      learnerCountAvg += m.learnerCount;
    });

    learnerCountAvg = learnerCountAvg / 12;

    const unit = activeTab === 'electricity' ? 'kWh' : 'KL';
    const effectiveCost = totalUsage > 0 ? (totalCost / totalUsage) : 0;
    const perLearner = learnerCountAvg > 0 ? (totalUsage / learnerCountAvg) : 0;

    return {
      totalCost,
      totalUsage,
      effectiveCost,
      perLearner,
      unit,
      learnerCountAvg
    };
  }, [currentData, activeTab]);

  // Chart Data Preparation
  const chartData = currentData.map(d => ({
    name: d.month,
    Usage: d[activeTab].usage,
    Cost: d[activeTab].breakdown['Total Cost']
  }));

  const formatCurrency = (val) => `R ${val.toLocaleString()}`;

  return (
    <div className={`min-h-screen transition-colors duration-300 font-sans 
      ${isDarkMode ? 'bg-gray-900 text-gray-100' : 'bg-slate-50 text-slate-900'}`}>
      
      {/* --- Top Navigation Bar --- */}
      <nav className={`px-6 py-4 shadow-sm sticky top-0 z-10 backdrop-blur-md border-b
        ${isDarkMode ? 'bg-gray-900/90 border-gray-800' : 'bg-white/90 border-gray-200'}`}>
        <div className="max-w-7xl mx-auto flex justify-between items-center">
          <div className="flex items-center space-x-3">
            <div className="p-2 bg-blue-600 rounded-lg shadow-lg shadow-blue-500/30">
              <Activity className="w-6 h-6 text-white" />
            </div>
            <div>
              <h1 className="text-xl font-bold tracking-tight">Municipal Charges</h1>
              <p className={`text-xs ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                Financial Overview & Utility Analytics
              </p>
            </div>
          </div>
          
          <button 
            onClick={() => setIsDarkMode(!isDarkMode)}
            className={`p-2 rounded-full transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2
              ${isDarkMode 
                ? 'bg-gray-800 text-yellow-400 hover:bg-gray-700 focus:ring-yellow-400' 
                : 'bg-gray-100 text-slate-600 hover:bg-gray-200 focus:ring-slate-400'}`}
          >
            {isDarkMode ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
          </button>
        </div>
      </nav>

      <main className="max-w-7xl mx-auto p-6 space-y-6">
        
        {/* --- Top Controls Section (Tabs + Years Inline) --- */}
        <div className={`flex flex-col lg:flex-row items-start lg:items-center`}>
          
          {/* Utility Tabs */}
          <div className={`flex p-1 space-x-1 rounded-lg shrink-0 ${isDarkMode ? 'bg-gray-800' : 'bg-white border border-gray-200'}`}>
            <button
              onClick={() => setActiveTab('electricity')}
              className={`flex items-center px-4 py-2 rounded-md text-sm font-medium transition-all
                ${activeTab === 'electricity' 
                  ? 'bg-amber-500 text-white shadow-md' 
                  : (isDarkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-900')}`}
            >
              <Zap className="w-4 h-4 mr-2" /> Electricity
            </button>
            <button
              onClick={() => setActiveTab('water')}
              className={`flex items-center px-4 py-2 rounded-md text-sm font-medium transition-all
                ${activeTab === 'water' 
                  ? 'bg-blue-500 text-white shadow-md' 
                  : (isDarkMode ? 'text-gray-400 hover:text-gray-200' : 'text-gray-500 hover:text-gray-900')}`}
            >
              <Droplets className="w-4 h-4 mr-2" /> Water
            </button>
          </div>

          {/* Inline Year Selector - Removed "Year" label and added left margin */}
          <div className="flex-1 w-full lg:w-auto overflow-hidden relative group ml-0 lg:ml-6 mt-4 lg:mt-0">
             <div className="absolute left-0 top-0 bottom-0 w-6 bg-gradient-to-r from-current to-transparent opacity-0 pointer-events-none z-10" />
              <div className="flex items-center gap-2 overflow-x-auto pb-1 scrollbar-hide mask-image-gradient">
                {/* Removed the Year Label Span */}
                {YEARS.map(year => (
                  <button
                    key={year}
                    onClick={() => setSelectedYear(year)}
                    className={`px-3 py-1.5 rounded-md text-xs font-medium whitespace-nowrap transition-all border shrink-0
                      ${selectedYear === year
                        ? (isDarkMode 
                            ? 'bg-indigo-600 border-indigo-500 text-white' 
                            : 'bg-indigo-600 border-indigo-600 text-white shadow-md')
                        : (isDarkMode
                            ? 'bg-gray-800 border-gray-700 text-gray-400 hover:bg-gray-700'
                            : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50')
                      }`}
                  >
                    {year}
                  </button>
                ))}
              </div>
             <div className="absolute right-0 top-0 bottom-0 w-6 bg-gradient-to-l from-current to-transparent opacity-0 pointer-events-none z-10" />
          </div>

        </div>

        {/* --- KPI Cards Grid --- */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <KPICard 
            title="Total Cost" 
            value={formatCurrency(stats.totalCost)}
            subtext={`For ${selectedYear}`}
            icon={DollarSign}
            colorClass="bg-emerald-500"
            isDark={isDarkMode}
          />
          <KPICard 
            title="Total Consumption" 
            value={`${stats.totalUsage.toLocaleString()} ${stats.unit}`}
            subtext={`For ${selectedYear}`}
            icon={activeTab === 'electricity' ? Zap : Droplets}
            colorClass={activeTab === 'electricity' ? 'bg-amber-500' : 'bg-blue-500'}
            isDark={isDarkMode}
          />
          <KPICard 
            title={`Annual Effective ${stats.unit} Cost`}
            value={`R ${stats.effectiveCost.toFixed(2)}`}
            subtext={`Per ${stats.unit}`}
            icon={TrendingUp}
            colorClass="bg-purple-500"
            isDark={isDarkMode}
          />
          <KPICard 
            title={`${stats.unit} Per Learner`} 
            value={`${stats.perLearner.toFixed(2)} ${stats.unit}`}
            subtext={`Avg Learners: ${Math.round(stats.learnerCountAvg)}`}
            icon={Users}
            colorClass="bg-pink-500"
            isDark={isDarkMode}
          />
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          
          {/* --- Main Chart Section (Takes up 2/3 columns) --- */}
          <div className={`col-span-1 lg:col-span-2 p-6 rounded-xl border shadow-sm ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
            <div className="flex flex-wrap items-center justify-between mb-6 gap-4">
              <div>
                <h2 className={`text-lg font-bold ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>
                  Monthly Trends: {selectedYear}
                </h2>
                <p className={`text-sm ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                  Comparison
                </p>
              </div>

              {/* Chart Metrics Toggle - Mutually Exclusive */}
              <div className={`flex items-center space-x-2 p-1 rounded-lg ${isDarkMode ? 'bg-gray-900' : 'bg-gray-100'}`}>
                {/* Usage Toggle */}
                <button 
                  onClick={() => setChartMetric('usage')}
                  className={`flex items-center space-x-2 px-3 py-1.5 rounded-md text-sm transition-all
                    ${chartMetric === 'usage' 
                      ? (activeTab === 'electricity' ? 'bg-amber-500 text-white shadow-sm' : 'bg-blue-500 text-white shadow-sm') 
                      : (isDarkMode ? 'text-gray-400 hover:bg-gray-800' : 'text-gray-500 hover:bg-gray-200')
                    }`}
                >
                  {activeTab === 'electricity' ? <Zap className="w-4 h-4" /> : <Droplets className="w-4 h-4" />}
                  <span>{activeTab === 'electricity' ? 'kWh' : 'KL'}</span>
                  {chartMetric === 'usage' && <Check className="w-3 h-3 ml-1" />}
                </button>

                {/* Cost Toggle */}
                <button 
                  onClick={() => setChartMetric('cost')}
                  className={`flex items-center space-x-2 px-3 py-1.5 rounded-md text-sm transition-all
                    ${chartMetric === 'cost' 
                      ? 'bg-emerald-500 text-white shadow-sm' 
                      : (isDarkMode ? 'text-gray-400 hover:bg-gray-800' : 'text-gray-500 hover:bg-gray-200')
                    }`}
                >
                  <DollarSign className="w-4 h-4" />
                  <span>Rand</span>
                  {chartMetric === 'cost' && <Check className="w-3 h-3 ml-1" />}
                </button>
              </div>
            </div>
            
            <div className="h-80 w-full">
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={chartData} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>
                  <CartesianGrid strokeDasharray="3 3" stroke={isDarkMode ? "#374151" : "#e5e7eb"} />
                  <XAxis 
                    dataKey="name" 
                    stroke={isDarkMode ? "#9ca3af" : "#4b5563"} 
                    tick={{ fill: isDarkMode ? "#9ca3af" : "#4b5563" }}
                  />
                  
                  {/* Render YAxis and Bar based on single selected metric */}
                  {chartMetric === 'usage' ? (
                    <>
                      <YAxis 
                        orientation="left" 
                        stroke={activeTab === 'electricity' ? "#f59e0b" : "#3b82f6"}
                        tick={{ fill: isDarkMode ? "#d1d5db" : "#374151" }}
                        label={{ 
                          value: stats.unit, 
                          angle: -90, 
                          position: 'insideLeft',
                          style: { fill: activeTab === 'electricity' ? "#f59e0b" : "#3b82f6" }
                        }}
                      />
                      <Bar 
                        dataKey="Usage" 
                        name={`${stats.unit} Consumption`} 
                        fill={activeTab === 'electricity' ? "#f59e0b" : "#3b82f6"} 
                        radius={[4, 4, 0, 0]}
                      />
                    </>
                  ) : (
                    <>
                      <YAxis 
                        orientation="left" 
                        stroke="#10b981"
                        tick={{ fill: isDarkMode ? "#d1d5db" : "#374151" }}
                        tickFormatter={(val) => `R${val/1000}k`}
                        label={{ 
                          value: 'Rand (R)', 
                          angle: -90, 
                          position: 'insideLeft',
                          style: { fill: "#10b981" }
                        }}
                      />
                      <Bar 
                        dataKey="Cost" 
                        name="Cost (Rand)" 
                        fill="#10b981" 
                        radius={[4, 4, 0, 0]}
                      />
                    </>
                  )}

                  <Tooltip 
                    contentStyle={{ 
                      backgroundColor: isDarkMode ? '#1f2937' : '#fff', 
                      borderColor: isDarkMode ? '#374151' : '#e5e7eb',
                      color: isDarkMode ? '#fff' : '#000'
                    }}
                    formatter={(value, name) => [
                      name === 'Cost (Rand)' ? `R ${value.toLocaleString()}` : `${value.toLocaleString()} ${stats.unit}`,
                      name
                    ]}
                  />
                  <Legend />
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>

          {/* --- Pie Chart Section (1/3 column) --- */}
          <div className={`col-span-1 p-6 rounded-xl border shadow-sm flex flex-col ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'}`}>
            <div className="mb-4">
              <h2 className={`text-lg font-bold ${isDarkMode ? 'text-white' : 'text-gray-800'}`}>
                Cost Distribution
              </h2>
              <p className={`text-sm ${isDarkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                Annual breakdown
              </p>
            </div>
            <div className="flex-1 flex items-center justify-center">
              <CostBreakdownPie 
                data={currentData} 
                utilityType={activeTab} 
                isDark={isDarkMode} 
              />
            </div>
          </div>

        </div>

      </main>
    </div>
  );
}